var http = require('http');
var send = require('send');
var parseUrl = require('parseurl')
var fs = require('fs');
var path = require('path')

// w3 static file server
// 
// Why?
// To make it stupid easy to fire up a web server in any directory
//
// Pass any port via command line
//
// w3 [dir]  
//
module.exports = function(port=3000, root='.', options={cache: false}) {
  http.createServer(function(req,res){
    var target = parseUrl(req).pathname
    // check if file exists
    // append html and check if exists
    // if not check if 404.html exists
    // serve index.html
    if (!fs.existsSync(path.resolve(root + target))) {
      if (fs.existsSync(path.resolve(root + target + '.html'))) {
        target = target + '.html'
      } else {
        if (fs.existsSync(path.resolve(root + '/404.html'))) {
          target = '/404.html'
        } else {
          target = '/index.html' 
        }
      }
    }


    send(req, target, { root, extensions: ['html'] }).pipe(res)
  }).listen(port, '0.0.0.0', function() {
    console.log(JSON.stringify({ 
      name: 'w3',
      port: port.toString(),
      directory: root,
      exit: 'ctrl-c'
    }, null , 2));
  });
}
